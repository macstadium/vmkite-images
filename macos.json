{
  "builders": [
    {
      "boot_wait": "2s",
      "disk_size": "{{user `disk_size`}}",
      "disk_type_id": "0",
      "guest_os_type": "darwin12-64",
      "headless": "{{ user `headless` }}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "iso_url": "{{user `iso_url`}}",
      "output_directory": "output/{{user `template`}}",
      "shutdown_command": "echo 'vmkite'| sudo -S shutdown -h now",
      "skip_compaction": true,
      "ssh_password": "vmkite",
      "ssh_port": 22,
      "ssh_username": "vmkite",
      "ssh_wait_timeout": "10000s",
      "tools_upload_flavor": "darwin",
      "tools_upload_path": "/tmp/vmtools.iso",
      "type": "vmware-iso",
      "vm_name": "{{ user `template` }}",
      "vnc_bind_address": "0.0.0.0",
      "vmx_data": {
        "cpuid.coresPerSocket": "1",
        "ehci.present": "TRUE",
        "firmware": "efi",
        "hpet0.present": "TRUE",
        "ich7m.present": "TRUE",
        "keyboardAndMouseProfile": "macProfile",
        "memsize": "{{ user `memory` }}",
        "numvcpus": "{{ user `cpus` }}",
        "smc.present": "TRUE",
        "usb.present": "TRUE"
      }
    }
  ],
  "provisioners": [
    {
      "destination": "/private/tmp/set_kcpassword.py",
      "source": "scripts/macos/support/set_kcpassword.py",
      "type": "file"
    },
    {
      "destination": "/tmp/vmkite/com.macstadium.vmkite-buildkite-agent.plist",
      "source": "scripts/macos/support/com.macstadium.vmkite-buildkite-agent.plist",
      "type": "file"
    },
    {
      "destination": "/tmp/vmkite/vmkite-buildkite-agent.sh",
      "source": "scripts/macos/support/vmkite-buildkite-agent.sh",
      "type": "file"
    },
    {
      "environment_vars": [
        "AUTOLOGIN={{user `autologin`}}",
        "INSTALL_XCODE_CLI_TOOLS=1",
        "HOME_DIR=/Users/vmkite",
        "USERNAME=vmkite",
        "PASSWORD=vmkite",
        "UPDATE_SYSTEM=1"
      ],
      "execute_command": "chmod +x {{ .Path }}; sudo {{ .Vars }} {{ .Path }}",
      "scripts": [
        "scripts/macos/computer-name.sh",
        "scripts/macos/vmware.sh",
        "scripts/macos/xcode-cli-tools.sh",
        "scripts/macos/add-network-interface-detection.sh",
        "scripts/macos/autologin.sh",
        "scripts/macos/system-update.sh",
        "scripts/macos/buildkite.sh"
      ],
      "type": "shell"
    }
  ],
  "post-processors": [{
    "type" : "vsphere",
    "keep_input_artifact" : true,
    "datacenter" : "MacStadium - Vegas",
    "cluster" : "XSERVE_Cluster",
    "datastore" : "PURE1-1",
    "host" : "10.92.157.10",
    "password" : "{{user `vsphere_password`}}",
    "username" : "{{user `vsphere_username`}}",
    "vm_folder": "/",
    "disk_mode": "thin",
    "vm_name": "vmkite-base-macos-{{ user `version` }}-r{{user `build_number`}}",
    "vm_network": "dvPortGroup-Private-1",
    "insecure" : true,
    "options": [
      "--X:logLevel=verbose"
    ]
  }],
  "variables": {
    "build_number": "{{env `BUILDKITE_BUILD_NUMBER`}}",
    "cpus": "1",
    "disk_size": "40960",
    "headless": "",
    "http_proxy": "{{env `http_proxy`}}",
    "https_proxy": "{{env `https_proxy`}}",
    "iso_checksum": "",
    "iso_checksum_type": "",
    "iso_url": "",
    "memory": "4096",
    "no_proxy": "{{env `no_proxy`}}",
    "template": "macos-{{ user `version` }}",
    "vsphere_username": "{{env `GOVC_USERNAME`}}",
    "vsphere_password": "{{env `GOVC_PASSWORD`}}"
  }
}